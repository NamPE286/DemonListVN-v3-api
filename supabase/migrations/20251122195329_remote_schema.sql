revoke delete on table "public"."APIKey" from "anon";

revoke insert on table "public"."APIKey" from "anon";

revoke references on table "public"."APIKey" from "anon";

revoke select on table "public"."APIKey" from "anon";

revoke trigger on table "public"."APIKey" from "anon";

revoke truncate on table "public"."APIKey" from "anon";

revoke update on table "public"."APIKey" from "anon";

revoke delete on table "public"."APIKey" from "authenticated";

revoke insert on table "public"."APIKey" from "authenticated";

revoke references on table "public"."APIKey" from "authenticated";

revoke select on table "public"."APIKey" from "authenticated";

revoke trigger on table "public"."APIKey" from "authenticated";

revoke truncate on table "public"."APIKey" from "authenticated";

revoke update on table "public"."APIKey" from "authenticated";

revoke delete on table "public"."APIKey" from "service_role";

revoke insert on table "public"."APIKey" from "service_role";

revoke references on table "public"."APIKey" from "service_role";

revoke select on table "public"."APIKey" from "service_role";

revoke trigger on table "public"."APIKey" from "service_role";

revoke truncate on table "public"."APIKey" from "service_role";

revoke update on table "public"."APIKey" from "service_role";

revoke delete on table "public"."PVPPlayers" from "anon";

revoke insert on table "public"."PVPPlayers" from "anon";

revoke references on table "public"."PVPPlayers" from "anon";

revoke select on table "public"."PVPPlayers" from "anon";

revoke trigger on table "public"."PVPPlayers" from "anon";

revoke truncate on table "public"."PVPPlayers" from "anon";

revoke update on table "public"."PVPPlayers" from "anon";

revoke delete on table "public"."PVPPlayers" from "authenticated";

revoke insert on table "public"."PVPPlayers" from "authenticated";

revoke references on table "public"."PVPPlayers" from "authenticated";

revoke select on table "public"."PVPPlayers" from "authenticated";

revoke trigger on table "public"."PVPPlayers" from "authenticated";

revoke truncate on table "public"."PVPPlayers" from "authenticated";

revoke update on table "public"."PVPPlayers" from "authenticated";

revoke delete on table "public"."PVPPlayers" from "service_role";

revoke insert on table "public"."PVPPlayers" from "service_role";

revoke references on table "public"."PVPPlayers" from "service_role";

revoke select on table "public"."PVPPlayers" from "service_role";

revoke trigger on table "public"."PVPPlayers" from "service_role";

revoke truncate on table "public"."PVPPlayers" from "service_role";

revoke update on table "public"."PVPPlayers" from "service_role";

revoke delete on table "public"."PVPRooms" from "anon";

revoke insert on table "public"."PVPRooms" from "anon";

revoke references on table "public"."PVPRooms" from "anon";

revoke select on table "public"."PVPRooms" from "anon";

revoke trigger on table "public"."PVPRooms" from "anon";

revoke truncate on table "public"."PVPRooms" from "anon";

revoke update on table "public"."PVPRooms" from "anon";

revoke delete on table "public"."PVPRooms" from "authenticated";

revoke insert on table "public"."PVPRooms" from "authenticated";

revoke references on table "public"."PVPRooms" from "authenticated";

revoke select on table "public"."PVPRooms" from "authenticated";

revoke trigger on table "public"."PVPRooms" from "authenticated";

revoke truncate on table "public"."PVPRooms" from "authenticated";

revoke update on table "public"."PVPRooms" from "authenticated";

revoke delete on table "public"."PVPRooms" from "service_role";

revoke insert on table "public"."PVPRooms" from "service_role";

revoke references on table "public"."PVPRooms" from "service_role";

revoke select on table "public"."PVPRooms" from "service_role";

revoke trigger on table "public"."PVPRooms" from "service_role";

revoke truncate on table "public"."PVPRooms" from "service_role";

revoke update on table "public"."PVPRooms" from "service_role";

revoke delete on table "public"."cards" from "anon";

revoke insert on table "public"."cards" from "anon";

revoke references on table "public"."cards" from "anon";

revoke select on table "public"."cards" from "anon";

revoke trigger on table "public"."cards" from "anon";

revoke truncate on table "public"."cards" from "anon";

revoke update on table "public"."cards" from "anon";

revoke delete on table "public"."cards" from "authenticated";

revoke insert on table "public"."cards" from "authenticated";

revoke references on table "public"."cards" from "authenticated";

revoke select on table "public"."cards" from "authenticated";

revoke trigger on table "public"."cards" from "authenticated";

revoke truncate on table "public"."cards" from "authenticated";

revoke update on table "public"."cards" from "authenticated";

revoke delete on table "public"."cards" from "service_role";

revoke insert on table "public"."cards" from "service_role";

revoke references on table "public"."cards" from "service_role";

revoke select on table "public"."cards" from "service_role";

revoke trigger on table "public"."cards" from "service_role";

revoke truncate on table "public"."cards" from "service_role";

revoke update on table "public"."cards" from "service_role";

revoke delete on table "public"."caseItems" from "anon";

revoke insert on table "public"."caseItems" from "anon";

revoke references on table "public"."caseItems" from "anon";

revoke select on table "public"."caseItems" from "anon";

revoke trigger on table "public"."caseItems" from "anon";

revoke truncate on table "public"."caseItems" from "anon";

revoke update on table "public"."caseItems" from "anon";

revoke delete on table "public"."caseItems" from "authenticated";

revoke insert on table "public"."caseItems" from "authenticated";

revoke references on table "public"."caseItems" from "authenticated";

revoke select on table "public"."caseItems" from "authenticated";

revoke trigger on table "public"."caseItems" from "authenticated";

revoke truncate on table "public"."caseItems" from "authenticated";

revoke update on table "public"."caseItems" from "authenticated";

revoke delete on table "public"."caseItems" from "service_role";

revoke insert on table "public"."caseItems" from "service_role";

revoke references on table "public"."caseItems" from "service_role";

revoke select on table "public"."caseItems" from "service_role";

revoke trigger on table "public"."caseItems" from "service_role";

revoke truncate on table "public"."caseItems" from "service_role";

revoke update on table "public"."caseItems" from "service_role";

revoke delete on table "public"."caseResult" from "anon";

revoke insert on table "public"."caseResult" from "anon";

revoke references on table "public"."caseResult" from "anon";

revoke select on table "public"."caseResult" from "anon";

revoke trigger on table "public"."caseResult" from "anon";

revoke truncate on table "public"."caseResult" from "anon";

revoke update on table "public"."caseResult" from "anon";

revoke delete on table "public"."caseResult" from "authenticated";

revoke insert on table "public"."caseResult" from "authenticated";

revoke references on table "public"."caseResult" from "authenticated";

revoke select on table "public"."caseResult" from "authenticated";

revoke trigger on table "public"."caseResult" from "authenticated";

revoke truncate on table "public"."caseResult" from "authenticated";

revoke update on table "public"."caseResult" from "authenticated";

revoke delete on table "public"."caseResult" from "service_role";

revoke insert on table "public"."caseResult" from "service_role";

revoke references on table "public"."caseResult" from "service_role";

revoke select on table "public"."caseResult" from "service_role";

revoke trigger on table "public"."caseResult" from "service_role";

revoke truncate on table "public"."caseResult" from "service_role";

revoke update on table "public"."caseResult" from "service_role";

revoke delete on table "public"."changelogs" from "anon";

revoke insert on table "public"."changelogs" from "anon";

revoke references on table "public"."changelogs" from "anon";

revoke select on table "public"."changelogs" from "anon";

revoke trigger on table "public"."changelogs" from "anon";

revoke truncate on table "public"."changelogs" from "anon";

revoke update on table "public"."changelogs" from "anon";

revoke delete on table "public"."changelogs" from "authenticated";

revoke insert on table "public"."changelogs" from "authenticated";

revoke references on table "public"."changelogs" from "authenticated";

revoke select on table "public"."changelogs" from "authenticated";

revoke trigger on table "public"."changelogs" from "authenticated";

revoke truncate on table "public"."changelogs" from "authenticated";

revoke update on table "public"."changelogs" from "authenticated";

revoke delete on table "public"."changelogs" from "service_role";

revoke insert on table "public"."changelogs" from "service_role";

revoke references on table "public"."changelogs" from "service_role";

revoke select on table "public"."changelogs" from "service_role";

revoke trigger on table "public"."changelogs" from "service_role";

revoke truncate on table "public"."changelogs" from "service_role";

revoke update on table "public"."changelogs" from "service_role";

revoke delete on table "public"."clanBan" from "anon";

revoke insert on table "public"."clanBan" from "anon";

revoke references on table "public"."clanBan" from "anon";

revoke select on table "public"."clanBan" from "anon";

revoke trigger on table "public"."clanBan" from "anon";

revoke truncate on table "public"."clanBan" from "anon";

revoke update on table "public"."clanBan" from "anon";

revoke delete on table "public"."clanBan" from "authenticated";

revoke insert on table "public"."clanBan" from "authenticated";

revoke references on table "public"."clanBan" from "authenticated";

revoke select on table "public"."clanBan" from "authenticated";

revoke trigger on table "public"."clanBan" from "authenticated";

revoke truncate on table "public"."clanBan" from "authenticated";

revoke update on table "public"."clanBan" from "authenticated";

revoke delete on table "public"."clanBan" from "service_role";

revoke insert on table "public"."clanBan" from "service_role";

revoke references on table "public"."clanBan" from "service_role";

revoke select on table "public"."clanBan" from "service_role";

revoke trigger on table "public"."clanBan" from "service_role";

revoke truncate on table "public"."clanBan" from "service_role";

revoke update on table "public"."clanBan" from "service_role";

revoke delete on table "public"."clanInvitations" from "anon";

revoke insert on table "public"."clanInvitations" from "anon";

revoke references on table "public"."clanInvitations" from "anon";

revoke select on table "public"."clanInvitations" from "anon";

revoke trigger on table "public"."clanInvitations" from "anon";

revoke truncate on table "public"."clanInvitations" from "anon";

revoke update on table "public"."clanInvitations" from "anon";

revoke delete on table "public"."clanInvitations" from "authenticated";

revoke insert on table "public"."clanInvitations" from "authenticated";

revoke references on table "public"."clanInvitations" from "authenticated";

revoke select on table "public"."clanInvitations" from "authenticated";

revoke trigger on table "public"."clanInvitations" from "authenticated";

revoke truncate on table "public"."clanInvitations" from "authenticated";

revoke update on table "public"."clanInvitations" from "authenticated";

revoke delete on table "public"."clanInvitations" from "service_role";

revoke insert on table "public"."clanInvitations" from "service_role";

revoke references on table "public"."clanInvitations" from "service_role";

revoke select on table "public"."clanInvitations" from "service_role";

revoke trigger on table "public"."clanInvitations" from "service_role";

revoke truncate on table "public"."clanInvitations" from "service_role";

revoke update on table "public"."clanInvitations" from "service_role";

revoke delete on table "public"."clans" from "anon";

revoke insert on table "public"."clans" from "anon";

revoke references on table "public"."clans" from "anon";

revoke select on table "public"."clans" from "anon";

revoke trigger on table "public"."clans" from "anon";

revoke truncate on table "public"."clans" from "anon";

revoke update on table "public"."clans" from "anon";

revoke delete on table "public"."clans" from "authenticated";

revoke insert on table "public"."clans" from "authenticated";

revoke references on table "public"."clans" from "authenticated";

revoke select on table "public"."clans" from "authenticated";

revoke trigger on table "public"."clans" from "authenticated";

revoke truncate on table "public"."clans" from "authenticated";

revoke update on table "public"."clans" from "authenticated";

revoke delete on table "public"."clans" from "service_role";

revoke insert on table "public"."clans" from "service_role";

revoke references on table "public"."clans" from "service_role";

revoke select on table "public"."clans" from "service_role";

revoke trigger on table "public"."clans" from "service_role";

revoke truncate on table "public"."clans" from "service_role";

revoke update on table "public"."clans" from "service_role";

revoke delete on table "public"."coupons" from "anon";

revoke insert on table "public"."coupons" from "anon";

revoke references on table "public"."coupons" from "anon";

revoke select on table "public"."coupons" from "anon";

revoke trigger on table "public"."coupons" from "anon";

revoke truncate on table "public"."coupons" from "anon";

revoke update on table "public"."coupons" from "anon";

revoke delete on table "public"."coupons" from "authenticated";

revoke insert on table "public"."coupons" from "authenticated";

revoke references on table "public"."coupons" from "authenticated";

revoke select on table "public"."coupons" from "authenticated";

revoke trigger on table "public"."coupons" from "authenticated";

revoke truncate on table "public"."coupons" from "authenticated";

revoke update on table "public"."coupons" from "authenticated";

revoke delete on table "public"."coupons" from "service_role";

revoke insert on table "public"."coupons" from "service_role";

revoke references on table "public"."coupons" from "service_role";

revoke select on table "public"."coupons" from "service_role";

revoke trigger on table "public"."coupons" from "service_role";

revoke truncate on table "public"."coupons" from "service_role";

revoke update on table "public"."coupons" from "service_role";

revoke delete on table "public"."deathCount" from "anon";

revoke insert on table "public"."deathCount" from "anon";

revoke references on table "public"."deathCount" from "anon";

revoke select on table "public"."deathCount" from "anon";

revoke trigger on table "public"."deathCount" from "anon";

revoke truncate on table "public"."deathCount" from "anon";

revoke update on table "public"."deathCount" from "anon";

revoke delete on table "public"."deathCount" from "authenticated";

revoke insert on table "public"."deathCount" from "authenticated";

revoke references on table "public"."deathCount" from "authenticated";

revoke select on table "public"."deathCount" from "authenticated";

revoke trigger on table "public"."deathCount" from "authenticated";

revoke truncate on table "public"."deathCount" from "authenticated";

revoke update on table "public"."deathCount" from "authenticated";

revoke delete on table "public"."deathCount" from "service_role";

revoke insert on table "public"."deathCount" from "service_role";

revoke references on table "public"."deathCount" from "service_role";

revoke select on table "public"."deathCount" from "service_role";

revoke trigger on table "public"."deathCount" from "service_role";

revoke truncate on table "public"."deathCount" from "service_role";

revoke update on table "public"."deathCount" from "service_role";

revoke delete on table "public"."eventLevels" from "anon";

revoke insert on table "public"."eventLevels" from "anon";

revoke references on table "public"."eventLevels" from "anon";

revoke select on table "public"."eventLevels" from "anon";

revoke trigger on table "public"."eventLevels" from "anon";

revoke truncate on table "public"."eventLevels" from "anon";

revoke update on table "public"."eventLevels" from "anon";

revoke delete on table "public"."eventLevels" from "authenticated";

revoke insert on table "public"."eventLevels" from "authenticated";

revoke references on table "public"."eventLevels" from "authenticated";

revoke select on table "public"."eventLevels" from "authenticated";

revoke trigger on table "public"."eventLevels" from "authenticated";

revoke truncate on table "public"."eventLevels" from "authenticated";

revoke update on table "public"."eventLevels" from "authenticated";

revoke delete on table "public"."eventLevels" from "service_role";

revoke insert on table "public"."eventLevels" from "service_role";

revoke references on table "public"."eventLevels" from "service_role";

revoke select on table "public"."eventLevels" from "service_role";

revoke trigger on table "public"."eventLevels" from "service_role";

revoke truncate on table "public"."eventLevels" from "service_role";

revoke update on table "public"."eventLevels" from "service_role";

revoke delete on table "public"."eventProofs" from "anon";

revoke insert on table "public"."eventProofs" from "anon";

revoke references on table "public"."eventProofs" from "anon";

revoke select on table "public"."eventProofs" from "anon";

revoke trigger on table "public"."eventProofs" from "anon";

revoke truncate on table "public"."eventProofs" from "anon";

revoke update on table "public"."eventProofs" from "anon";

revoke delete on table "public"."eventProofs" from "authenticated";

revoke insert on table "public"."eventProofs" from "authenticated";

revoke references on table "public"."eventProofs" from "authenticated";

revoke select on table "public"."eventProofs" from "authenticated";

revoke trigger on table "public"."eventProofs" from "authenticated";

revoke truncate on table "public"."eventProofs" from "authenticated";

revoke update on table "public"."eventProofs" from "authenticated";

revoke delete on table "public"."eventProofs" from "service_role";

revoke insert on table "public"."eventProofs" from "service_role";

revoke references on table "public"."eventProofs" from "service_role";

revoke select on table "public"."eventProofs" from "service_role";

revoke trigger on table "public"."eventProofs" from "service_role";

revoke truncate on table "public"."eventProofs" from "service_role";

revoke update on table "public"."eventProofs" from "service_role";

revoke delete on table "public"."eventRecords" from "anon";

revoke insert on table "public"."eventRecords" from "anon";

revoke references on table "public"."eventRecords" from "anon";

revoke select on table "public"."eventRecords" from "anon";

revoke trigger on table "public"."eventRecords" from "anon";

revoke truncate on table "public"."eventRecords" from "anon";

revoke update on table "public"."eventRecords" from "anon";

revoke delete on table "public"."eventRecords" from "authenticated";

revoke insert on table "public"."eventRecords" from "authenticated";

revoke references on table "public"."eventRecords" from "authenticated";

revoke select on table "public"."eventRecords" from "authenticated";

revoke trigger on table "public"."eventRecords" from "authenticated";

revoke truncate on table "public"."eventRecords" from "authenticated";

revoke update on table "public"."eventRecords" from "authenticated";

revoke delete on table "public"."eventRecords" from "service_role";

revoke insert on table "public"."eventRecords" from "service_role";

revoke references on table "public"."eventRecords" from "service_role";

revoke select on table "public"."eventRecords" from "service_role";

revoke trigger on table "public"."eventRecords" from "service_role";

revoke truncate on table "public"."eventRecords" from "service_role";

revoke update on table "public"."eventRecords" from "service_role";

revoke delete on table "public"."events" from "anon";

revoke insert on table "public"."events" from "anon";

revoke references on table "public"."events" from "anon";

revoke select on table "public"."events" from "anon";

revoke trigger on table "public"."events" from "anon";

revoke truncate on table "public"."events" from "anon";

revoke update on table "public"."events" from "anon";

revoke delete on table "public"."events" from "authenticated";

revoke insert on table "public"."events" from "authenticated";

revoke references on table "public"."events" from "authenticated";

revoke select on table "public"."events" from "authenticated";

revoke trigger on table "public"."events" from "authenticated";

revoke truncate on table "public"."events" from "authenticated";

revoke update on table "public"."events" from "authenticated";

revoke delete on table "public"."events" from "service_role";

revoke insert on table "public"."events" from "service_role";

revoke references on table "public"."events" from "service_role";

revoke select on table "public"."events" from "service_role";

revoke trigger on table "public"."events" from "service_role";

revoke truncate on table "public"."events" from "service_role";

revoke update on table "public"."events" from "service_role";

revoke delete on table "public"."heatmap" from "anon";

revoke insert on table "public"."heatmap" from "anon";

revoke references on table "public"."heatmap" from "anon";

revoke select on table "public"."heatmap" from "anon";

revoke trigger on table "public"."heatmap" from "anon";

revoke truncate on table "public"."heatmap" from "anon";

revoke update on table "public"."heatmap" from "anon";

revoke delete on table "public"."heatmap" from "authenticated";

revoke insert on table "public"."heatmap" from "authenticated";

revoke references on table "public"."heatmap" from "authenticated";

revoke select on table "public"."heatmap" from "authenticated";

revoke trigger on table "public"."heatmap" from "authenticated";

revoke truncate on table "public"."heatmap" from "authenticated";

revoke update on table "public"."heatmap" from "authenticated";

revoke delete on table "public"."heatmap" from "service_role";

revoke insert on table "public"."heatmap" from "service_role";

revoke references on table "public"."heatmap" from "service_role";

revoke select on table "public"."heatmap" from "service_role";

revoke trigger on table "public"."heatmap" from "service_role";

revoke truncate on table "public"."heatmap" from "service_role";

revoke update on table "public"."heatmap" from "service_role";

revoke delete on table "public"."inventory" from "anon";

revoke insert on table "public"."inventory" from "anon";

revoke references on table "public"."inventory" from "anon";

revoke select on table "public"."inventory" from "anon";

revoke trigger on table "public"."inventory" from "anon";

revoke truncate on table "public"."inventory" from "anon";

revoke update on table "public"."inventory" from "anon";

revoke delete on table "public"."inventory" from "authenticated";

revoke insert on table "public"."inventory" from "authenticated";

revoke references on table "public"."inventory" from "authenticated";

revoke select on table "public"."inventory" from "authenticated";

revoke trigger on table "public"."inventory" from "authenticated";

revoke truncate on table "public"."inventory" from "authenticated";

revoke update on table "public"."inventory" from "authenticated";

revoke delete on table "public"."inventory" from "service_role";

revoke insert on table "public"."inventory" from "service_role";

revoke references on table "public"."inventory" from "service_role";

revoke select on table "public"."inventory" from "service_role";

revoke trigger on table "public"."inventory" from "service_role";

revoke truncate on table "public"."inventory" from "service_role";

revoke update on table "public"."inventory" from "service_role";

revoke delete on table "public"."items" from "anon";

revoke insert on table "public"."items" from "anon";

revoke references on table "public"."items" from "anon";

revoke select on table "public"."items" from "anon";

revoke trigger on table "public"."items" from "anon";

revoke truncate on table "public"."items" from "anon";

revoke update on table "public"."items" from "anon";

revoke delete on table "public"."items" from "authenticated";

revoke insert on table "public"."items" from "authenticated";

revoke references on table "public"."items" from "authenticated";

revoke select on table "public"."items" from "authenticated";

revoke trigger on table "public"."items" from "authenticated";

revoke truncate on table "public"."items" from "authenticated";

revoke update on table "public"."items" from "authenticated";

revoke delete on table "public"."items" from "service_role";

revoke insert on table "public"."items" from "service_role";

revoke references on table "public"."items" from "service_role";

revoke select on table "public"."items" from "service_role";

revoke trigger on table "public"."items" from "service_role";

revoke truncate on table "public"."items" from "service_role";

revoke update on table "public"."items" from "service_role";

revoke delete on table "public"."levelDeathCount" from "anon";

revoke insert on table "public"."levelDeathCount" from "anon";

revoke references on table "public"."levelDeathCount" from "anon";

revoke select on table "public"."levelDeathCount" from "anon";

revoke trigger on table "public"."levelDeathCount" from "anon";

revoke truncate on table "public"."levelDeathCount" from "anon";

revoke update on table "public"."levelDeathCount" from "anon";

revoke delete on table "public"."levelDeathCount" from "authenticated";

revoke insert on table "public"."levelDeathCount" from "authenticated";

revoke references on table "public"."levelDeathCount" from "authenticated";

revoke select on table "public"."levelDeathCount" from "authenticated";

revoke trigger on table "public"."levelDeathCount" from "authenticated";

revoke truncate on table "public"."levelDeathCount" from "authenticated";

revoke update on table "public"."levelDeathCount" from "authenticated";

revoke delete on table "public"."levelDeathCount" from "service_role";

revoke insert on table "public"."levelDeathCount" from "service_role";

revoke references on table "public"."levelDeathCount" from "service_role";

revoke select on table "public"."levelDeathCount" from "service_role";

revoke trigger on table "public"."levelDeathCount" from "service_role";

revoke truncate on table "public"."levelDeathCount" from "service_role";

revoke update on table "public"."levelDeathCount" from "service_role";

revoke delete on table "public"."levels" from "anon";

revoke insert on table "public"."levels" from "anon";

revoke references on table "public"."levels" from "anon";

revoke select on table "public"."levels" from "anon";

revoke trigger on table "public"."levels" from "anon";

revoke truncate on table "public"."levels" from "anon";

revoke update on table "public"."levels" from "anon";

revoke delete on table "public"."levels" from "authenticated";

revoke insert on table "public"."levels" from "authenticated";

revoke references on table "public"."levels" from "authenticated";

revoke select on table "public"."levels" from "authenticated";

revoke trigger on table "public"."levels" from "authenticated";

revoke truncate on table "public"."levels" from "authenticated";

revoke update on table "public"."levels" from "authenticated";

revoke delete on table "public"."levels" from "service_role";

revoke insert on table "public"."levels" from "service_role";

revoke references on table "public"."levels" from "service_role";

revoke select on table "public"."levels" from "service_role";

revoke trigger on table "public"."levels" from "service_role";

revoke truncate on table "public"."levels" from "service_role";

revoke update on table "public"."levels" from "service_role";

revoke delete on table "public"."notifications" from "anon";

revoke insert on table "public"."notifications" from "anon";

revoke references on table "public"."notifications" from "anon";

revoke select on table "public"."notifications" from "anon";

revoke trigger on table "public"."notifications" from "anon";

revoke truncate on table "public"."notifications" from "anon";

revoke update on table "public"."notifications" from "anon";

revoke delete on table "public"."notifications" from "authenticated";

revoke insert on table "public"."notifications" from "authenticated";

revoke references on table "public"."notifications" from "authenticated";

revoke select on table "public"."notifications" from "authenticated";

revoke trigger on table "public"."notifications" from "authenticated";

revoke truncate on table "public"."notifications" from "authenticated";

revoke update on table "public"."notifications" from "authenticated";

revoke delete on table "public"."notifications" from "service_role";

revoke insert on table "public"."notifications" from "service_role";

revoke references on table "public"."notifications" from "service_role";

revoke select on table "public"."notifications" from "service_role";

revoke trigger on table "public"."notifications" from "service_role";

revoke truncate on table "public"."notifications" from "service_role";

revoke update on table "public"."notifications" from "service_role";

revoke delete on table "public"."orderItems" from "anon";

revoke insert on table "public"."orderItems" from "anon";

revoke references on table "public"."orderItems" from "anon";

revoke select on table "public"."orderItems" from "anon";

revoke trigger on table "public"."orderItems" from "anon";

revoke truncate on table "public"."orderItems" from "anon";

revoke update on table "public"."orderItems" from "anon";

revoke delete on table "public"."orderItems" from "authenticated";

revoke insert on table "public"."orderItems" from "authenticated";

revoke references on table "public"."orderItems" from "authenticated";

revoke select on table "public"."orderItems" from "authenticated";

revoke trigger on table "public"."orderItems" from "authenticated";

revoke truncate on table "public"."orderItems" from "authenticated";

revoke update on table "public"."orderItems" from "authenticated";

revoke delete on table "public"."orderItems" from "service_role";

revoke insert on table "public"."orderItems" from "service_role";

revoke references on table "public"."orderItems" from "service_role";

revoke select on table "public"."orderItems" from "service_role";

revoke trigger on table "public"."orderItems" from "service_role";

revoke truncate on table "public"."orderItems" from "service_role";

revoke update on table "public"."orderItems" from "service_role";

revoke delete on table "public"."orderTracking" from "anon";

revoke insert on table "public"."orderTracking" from "anon";

revoke references on table "public"."orderTracking" from "anon";

revoke select on table "public"."orderTracking" from "anon";

revoke trigger on table "public"."orderTracking" from "anon";

revoke truncate on table "public"."orderTracking" from "anon";

revoke update on table "public"."orderTracking" from "anon";

revoke delete on table "public"."orderTracking" from "authenticated";

revoke insert on table "public"."orderTracking" from "authenticated";

revoke references on table "public"."orderTracking" from "authenticated";

revoke select on table "public"."orderTracking" from "authenticated";

revoke trigger on table "public"."orderTracking" from "authenticated";

revoke truncate on table "public"."orderTracking" from "authenticated";

revoke update on table "public"."orderTracking" from "authenticated";

revoke delete on table "public"."orderTracking" from "service_role";

revoke insert on table "public"."orderTracking" from "service_role";

revoke references on table "public"."orderTracking" from "service_role";

revoke select on table "public"."orderTracking" from "service_role";

revoke trigger on table "public"."orderTracking" from "service_role";

revoke truncate on table "public"."orderTracking" from "service_role";

revoke update on table "public"."orderTracking" from "service_role";

revoke delete on table "public"."orders" from "anon";

revoke insert on table "public"."orders" from "anon";

revoke references on table "public"."orders" from "anon";

revoke select on table "public"."orders" from "anon";

revoke trigger on table "public"."orders" from "anon";

revoke truncate on table "public"."orders" from "anon";

revoke update on table "public"."orders" from "anon";

revoke delete on table "public"."orders" from "authenticated";

revoke insert on table "public"."orders" from "authenticated";

revoke references on table "public"."orders" from "authenticated";

revoke select on table "public"."orders" from "authenticated";

revoke trigger on table "public"."orders" from "authenticated";

revoke truncate on table "public"."orders" from "authenticated";

revoke update on table "public"."orders" from "authenticated";

revoke delete on table "public"."orders" from "service_role";

revoke insert on table "public"."orders" from "service_role";

revoke references on table "public"."orders" from "service_role";

revoke select on table "public"."orders" from "service_role";

revoke trigger on table "public"."orders" from "service_role";

revoke truncate on table "public"."orders" from "service_role";

revoke update on table "public"."orders" from "service_role";

revoke delete on table "public"."players" from "anon";

revoke insert on table "public"."players" from "anon";

revoke references on table "public"."players" from "anon";

revoke select on table "public"."players" from "anon";

revoke trigger on table "public"."players" from "anon";

revoke truncate on table "public"."players" from "anon";

revoke update on table "public"."players" from "anon";

revoke delete on table "public"."players" from "authenticated";

revoke insert on table "public"."players" from "authenticated";

revoke references on table "public"."players" from "authenticated";

revoke select on table "public"."players" from "authenticated";

revoke trigger on table "public"."players" from "authenticated";

revoke truncate on table "public"."players" from "authenticated";

revoke update on table "public"."players" from "authenticated";

revoke delete on table "public"."players" from "service_role";

revoke insert on table "public"."players" from "service_role";

revoke references on table "public"."players" from "service_role";

revoke select on table "public"."players" from "service_role";

revoke trigger on table "public"."players" from "service_role";

revoke truncate on table "public"."players" from "service_role";

revoke update on table "public"."players" from "service_role";

revoke delete on table "public"."playersAchievement" from "anon";

revoke insert on table "public"."playersAchievement" from "anon";

revoke references on table "public"."playersAchievement" from "anon";

revoke select on table "public"."playersAchievement" from "anon";

revoke trigger on table "public"."playersAchievement" from "anon";

revoke truncate on table "public"."playersAchievement" from "anon";

revoke update on table "public"."playersAchievement" from "anon";

revoke delete on table "public"."playersAchievement" from "authenticated";

revoke insert on table "public"."playersAchievement" from "authenticated";

revoke references on table "public"."playersAchievement" from "authenticated";

revoke select on table "public"."playersAchievement" from "authenticated";

revoke trigger on table "public"."playersAchievement" from "authenticated";

revoke truncate on table "public"."playersAchievement" from "authenticated";

revoke update on table "public"."playersAchievement" from "authenticated";

revoke delete on table "public"."playersAchievement" from "service_role";

revoke insert on table "public"."playersAchievement" from "service_role";

revoke references on table "public"."playersAchievement" from "service_role";

revoke select on table "public"."playersAchievement" from "service_role";

revoke trigger on table "public"."playersAchievement" from "service_role";

revoke truncate on table "public"."playersAchievement" from "service_role";

revoke update on table "public"."playersAchievement" from "service_role";

revoke delete on table "public"."products" from "anon";

revoke insert on table "public"."products" from "anon";

revoke references on table "public"."products" from "anon";

revoke select on table "public"."products" from "anon";

revoke trigger on table "public"."products" from "anon";

revoke truncate on table "public"."products" from "anon";

revoke update on table "public"."products" from "anon";

revoke delete on table "public"."products" from "authenticated";

revoke insert on table "public"."products" from "authenticated";

revoke references on table "public"."products" from "authenticated";

revoke select on table "public"."products" from "authenticated";

revoke trigger on table "public"."products" from "authenticated";

revoke truncate on table "public"."products" from "authenticated";

revoke update on table "public"."products" from "authenticated";

revoke delete on table "public"."products" from "service_role";

revoke insert on table "public"."products" from "service_role";

revoke references on table "public"."products" from "service_role";

revoke select on table "public"."products" from "service_role";

revoke trigger on table "public"."products" from "service_role";

revoke truncate on table "public"."products" from "service_role";

revoke update on table "public"."products" from "service_role";

revoke delete on table "public"."records" from "anon";

revoke insert on table "public"."records" from "anon";

revoke references on table "public"."records" from "anon";

revoke select on table "public"."records" from "anon";

revoke trigger on table "public"."records" from "anon";

revoke truncate on table "public"."records" from "anon";

revoke update on table "public"."records" from "anon";

revoke delete on table "public"."records" from "authenticated";

revoke insert on table "public"."records" from "authenticated";

revoke references on table "public"."records" from "authenticated";

revoke select on table "public"."records" from "authenticated";

revoke trigger on table "public"."records" from "authenticated";

revoke truncate on table "public"."records" from "authenticated";

revoke update on table "public"."records" from "authenticated";

revoke delete on table "public"."records" from "service_role";

revoke insert on table "public"."records" from "service_role";

revoke references on table "public"."records" from "service_role";

revoke select on table "public"."records" from "service_role";

revoke trigger on table "public"."records" from "service_role";

revoke truncate on table "public"."records" from "service_role";

revoke update on table "public"."records" from "service_role";

revoke delete on table "public"."rules" from "anon";

revoke insert on table "public"."rules" from "anon";

revoke references on table "public"."rules" from "anon";

revoke select on table "public"."rules" from "anon";

revoke trigger on table "public"."rules" from "anon";

revoke truncate on table "public"."rules" from "anon";

revoke update on table "public"."rules" from "anon";

revoke delete on table "public"."rules" from "authenticated";

revoke insert on table "public"."rules" from "authenticated";

revoke references on table "public"."rules" from "authenticated";

revoke select on table "public"."rules" from "authenticated";

revoke trigger on table "public"."rules" from "authenticated";

revoke truncate on table "public"."rules" from "authenticated";

revoke update on table "public"."rules" from "authenticated";

revoke delete on table "public"."rules" from "service_role";

revoke insert on table "public"."rules" from "service_role";

revoke references on table "public"."rules" from "service_role";

revoke select on table "public"."rules" from "service_role";

revoke trigger on table "public"."rules" from "service_role";

revoke truncate on table "public"."rules" from "service_role";

revoke update on table "public"."rules" from "service_role";

revoke delete on table "public"."userSocial" from "anon";

revoke insert on table "public"."userSocial" from "anon";

revoke references on table "public"."userSocial" from "anon";

revoke select on table "public"."userSocial" from "anon";

revoke trigger on table "public"."userSocial" from "anon";

revoke truncate on table "public"."userSocial" from "anon";

revoke update on table "public"."userSocial" from "anon";

revoke delete on table "public"."userSocial" from "authenticated";

revoke insert on table "public"."userSocial" from "authenticated";

revoke references on table "public"."userSocial" from "authenticated";

revoke select on table "public"."userSocial" from "authenticated";

revoke trigger on table "public"."userSocial" from "authenticated";

revoke truncate on table "public"."userSocial" from "authenticated";

revoke update on table "public"."userSocial" from "authenticated";

revoke delete on table "public"."userSocial" from "service_role";

revoke insert on table "public"."userSocial" from "service_role";

revoke references on table "public"."userSocial" from "service_role";

revoke select on table "public"."userSocial" from "service_role";

revoke trigger on table "public"."userSocial" from "service_role";

revoke truncate on table "public"."userSocial" from "service_role";

revoke update on table "public"."userSocial" from "service_role";

create table "public"."eventQuestClaims" (
    "created_at" timestamp with time zone not null default now(),
    "userId" uuid not null,
    "questId" bigint not null
);


alter table "public"."eventQuestClaims" enable row level security;

create table "public"."eventQuests" (
    "id" bigint generated by default as identity not null,
    "eventId" bigint not null,
    "created_at" timestamp with time zone not null default now(),
    "title" text,
    "condition" jsonb not null,
    "rewardItemId" bigint
);


alter table "public"."eventQuests" enable row level security;

alter table "public"."caseItems" alter column "expireAfter" set default '604800000'::bigint;

alter table "public"."inventory" alter column "consumed" set not null;

alter table "public"."players" alter column "uid" set default extensions.uuid_generate_v4();

CREATE UNIQUE INDEX "caseItems_pkey" ON public."caseItems" USING btree ("itemId", "caseId");

CREATE UNIQUE INDEX "eventQuestClaims_pkey" ON public."eventQuestClaims" USING btree ("userId", "questId");

CREATE UNIQUE INDEX "eventQuests_pkey" ON public."eventQuests" USING btree (id);

alter table "public"."caseItems" add constraint "caseItems_pkey" PRIMARY KEY using index "caseItems_pkey";

alter table "public"."eventQuestClaims" add constraint "eventQuestClaims_pkey" PRIMARY KEY using index "eventQuestClaims_pkey";

alter table "public"."eventQuests" add constraint "eventQuests_pkey" PRIMARY KEY using index "eventQuests_pkey";

alter table "public"."eventQuestClaims" add constraint "eventQuestClaims_questId_fkey" FOREIGN KEY ("questId") REFERENCES "eventQuests"(id) not valid;

alter table "public"."eventQuestClaims" validate constraint "eventQuestClaims_questId_fkey";

alter table "public"."eventQuestClaims" add constraint "eventQuestClaims_userId_fkey" FOREIGN KEY ("userId") REFERENCES players(uid) not valid;

alter table "public"."eventQuestClaims" validate constraint "eventQuestClaims_userId_fkey";

alter table "public"."eventQuests" add constraint "eventQuests_eventId_fkey" FOREIGN KEY ("eventId") REFERENCES events(id) not valid;

alter table "public"."eventQuests" validate constraint "eventQuests_eventId_fkey";

alter table "public"."eventQuests" add constraint "eventQuests_rewardItemId_fkey" FOREIGN KEY ("rewardItemId") REFERENCES items(id) not valid;

alter table "public"."eventQuests" validate constraint "eventQuests_rewardItemId_fkey";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.add_event_levels_progress(updates jsonb)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  item jsonb;
BEGIN
  FOR item IN SELECT * FROM jsonb_array_elements(updates)
  LOOP
    UPDATE "eventLevels"
    SET "totalProgress" = "totalProgress" + (item->>'gained')::float
    WHERE "id" = (item->>'level_id')::int;
  END LOOP;
END;
$function$
;

CREATE OR REPLACE FUNCTION public."getEventLeaderboard"(event_id integer)
 RETURNS TABLE("userID" uuid, elo bigint, "matchCount" bigint, point numeric, penalty numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    er."userID",
    p.elo,
    p."matchCount",
    COALESCE(SUM((er.progress::numeric * el.point::numeric) / 100), 0) AS point,
    SUM(
      EXTRACT(EPOCH FROM (er.created_at - e.start)) / 60
    ) AS penalty
  FROM
    "eventRecords" AS er
    JOIN "eventLevels" AS el ON er."levelID" = el.id
    JOIN events AS e ON e.id = el."eventID"
    JOIN players AS p ON p.uid = er."userID"
  WHERE
    el."eventID" = event_id
  GROUP BY
    er."userID",
    p."elo",
    p."matchCount"
  ORDER BY
    point DESC,
    penalty ASC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_random_levels(row_count integer, filter_type text)
 RETURNS SETOF levels
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT *
    FROM levels
    WHERE
        (
            filter_type IS NULL
        )
        OR
        (
            filter_type = 'fl'
            AND "flTop" IS NOT NULL
        )
        OR
        (
            filter_type = 'dl'
            AND "dlTop" IS NOT NULL
            AND "isPlatformer" = false
        )
        OR
        (
            filter_type = 'pl'
            AND "dlTop" IS NOT NULL
            AND "isPlatformer" = true
        )
    ORDER BY RANDOM()
    LIMIT row_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public."updateList"()
 RETURNS void
 LANGUAGE plpgsql
AS $function$begin
WITH
  v_table_name AS (
    SELECT
      id,
      (
        case
          when "flTop" is not null then RANK() OVER (
            ORDER BY
              "flTop" asc nulls last
          )
        end
      ) as ab
    FROM
      levels
  )
UPDATE
  levels
set
  "flTop" = v_table_name.ab
FROM
  v_table_name
WHERE
  levels.id = v_table_name.id;

WITH
  v_table_name AS (
    SELECT
      id,
      "isPlatformer",
      (
        case
          when "rating" is not null then RANK() OVER (
            ORDER BY
              "rating" desc nulls last
          )
        end
      ) as ab
    FROM
      levels
    where "isPlatformer" = false
  )
UPDATE
  levels
set
  "dlTop" = v_table_name.ab
FROM
  v_table_name
WHERE
  levels.id = v_table_name.id;

WITH
  v_table_name AS (
    SELECT
      id,
      "isPlatformer",
      (
        case
          when "rating" is not null then RANK() OVER (
            ORDER BY
              "rating" desc nulls last
          )
        end
      ) as ab
    FROM
      levels
    where "isPlatformer" = true
  )
UPDATE
  levels
set
  "dlTop" = v_table_name.ab
FROM
  v_table_name
WHERE
  levels.id = v_table_name.id;

UPDATE
  levels
SET
  "flPt" = cast(
    2250 / (0.4 * ("flTop") + 7) - 55 as decimal(16, 2)
  )
where
  "flTop" < 76;

UPDATE
  levels
SET
  "flPt" = 1
where
  "flTop" > 75;

update clans
set "memberCount" = (select count(*) from players where players.clan = clans.id)
where true;

update levels set "flPt" = null where "flTop" is null;
update levels set "dlTop" = null where "rating" is null;
end$function$
;

CREATE OR REPLACE FUNCTION public."updateRank"()
 RETURNS void
 LANGUAGE plpgsql
AS $function$begin
update players
set
  "isHidden" = true
where
  "isBanned" = true;

with
  v_table_a as (
    select
      records.userid,
      records.levelid,
      records."dlPt",
      levels.rating,
      rank() over (
        partition by
          userid
        order by
          case
            when records."isChecked" = false then null
            when records.progress = 100 then levels.rating
            else levels.rating * records.progress / 150
          end desc nulls last,
          levels.name
      ) as no
    from
      records,
      levels
    where
      levels.id = records.levelid
      and levels."isPlatformer" = false
  )
update records
set
  no = v_table_a.no
from
  v_table_a
where
  records.userid = v_table_a.userid
  and records.levelid = v_table_a.levelid
  and v_table_a.rating is not null;

update records
set
  "flPt" = cast(
    (
      select
        "flPt"
      from
        levels
      where
        levels.id = records.levelid
    ) as decimal(16, 2)
  )
where
  progress = 100;

with
  v_b as (
    select
      records.userid,
      records.levelid,
      case
        when records.no is null then null
        when records.no = 1 then levels.rating * 5 / 10
        when records.no = 2 then levels.rating * 3 / 10
        when records.no = 3 then levels.rating * 2 / 10
        when (
          records.no > 3
          and records.no <= 15
        ) then greatest(
          5,
          floor(levels.rating * (25.0 / records.no) / 100)
        )
        when (
          records.no > 15
          and records.no <= 25
        ) then 5
        else 1
      end as pt
    from
      records,
      levels
    where
      levels.id = records.levelid
      and levels."isPlatformer" = false
  )
update records
set
  "dlPt" = v_b.pt
from
  v_b
where
  records.userid = v_b.userid
  and records.levelid = v_b.levelid
  and records.progress = 100;

with
  v_b as (
    select
      records.userid,
      records.levelid,
      case
        when records.no is null then null
        when records.no = 1 then levels.rating * 5 / 10
        when records.no = 2 then levels.rating * 3 / 10
        when records.no = 3 then levels.rating * 2 / 10
        when (
          records.no > 1
          and records.no <= 15
        ) then greatest(
          5,
          floor(levels.rating * (25.0 / records.no) / 100)
        )
        when (
          records.no > 15
          and records.no <= 25
        ) then 5
        else 1
      end as pt
    from
      records,
      levels
    where
      levels.id = records.levelid
      and levels."isPlatformer" = false
  )
update records
set
  "dlPt" = v_b.pt * progress / 150
from
  v_b
where
  records.userid = v_b.userid
  and records.levelid = v_b.levelid
  and records.progress < 100;

update players
set
  "totalFLpt" = (
    select
      sum("flPt")
    from
      records
    where
      records.userid = players.uid
      and records."isChecked" = true
  )
where
  true;

update players
set
  "totalDLpt" = (
    select
      sum("dlPt")
    from
      records
    where
      records.userid = players.uid
      and records."isChecked" = true
  )
where
  true;

update players
set
  "dlMaxPt" = greatest(
    (
      select
        max("dlPt")
      from
        records
      where
        records.userid = players.uid
        and records."isChecked" = true
    ),
    -1
  )
where
  true;

update players
set
  "flMaxPt" = greatest(
    (
      select
        max("flPt")
      from
        records
      where
        records.userid = players.uid
        and records."isChecked" = true
    ),
    -1
  )
where
  true;

update players
set
  rating = cast(
    (
      select
        sum("dlPt")
      from
        records
      where
        records.userid = players.uid
        and records."isChecked" = true
    ) as integer
  )
where
  true;

update players
set
  rating = null
where
  "isHidden";

with
  v_table_name as (
    select
      uid,
      (
        case
          when "totalFLpt" is not null then RANK() over (
            order by
              "totalFLpt" desc nulls last
          )
        end
      ) as ab
    from
      players
  )
update players
set
  "flrank" = v_table_name.ab
from
  v_table_name
where
  players.uid = v_table_name.uid;

with
  v_table_name as (
    select
      uid,
      (
        case
          when "totalDLpt" is not null then RANK() over (
            order by
              "totalDLpt" desc nulls last
          )
        end
      ) as ab
    from
      players
  )
update players
set
  "dlrank" = v_table_name.ab
from
  v_table_name
where
  players.uid = v_table_name.uid;

with
  v_table_name as (
    select
      uid,
      (
        case
          when "rating" is not null
          and "rating" != 0 then RANK() over (
            order by
              "rating" desc nulls last
          )
        end
      ) as ab
    from
      players
  )
update players
set
  "overallRank" = v_table_name.ab
from
  v_table_name
where
  players.uid = v_table_name.uid;

with
  v_table_a as (
    select
      userid,
      count(*)
    from
      records
    where
      "isChecked" = true
    group by
      userid
  )
update players
set
  "recordCount" = v_table_a.count
from
  v_table_a
where
  players.uid = v_table_a.userid;

with
  v_table_a as (
    select
      records.userid,
      coalesce(sum(levels.rating), 0) as sum,
      count(*)
    from
      records,
      levels
    where
      levels.id = records.levelid
      and records."isChecked" = true
    group by
      records.userid
  )
update players
set
  exp = v_table_a.count * 50 + v_table_a.sum
from
  v_table_a
where
  uid = v_table_a.userid;

update players
set
  "extraExp" = 0
where
  true;

with
  v_table_a as (
    select
      "eventProofs".userid,
      sum(events.exp)
    from
      events,
      "eventProofs"
    where
      events.id = "eventProofs"."eventID"
      and "eventProofs".accepted = true
    group by
      "eventProofs".userid
  )
update players
set
  "extraExp" = v_table_a.sum
from
  v_table_a
where
  players.uid = v_table_a.userid;

update records
set
  "queueNo" = null
where
  true;

with
  RankedRecords as (
    select
      ROW_NUMBER() over (
        order by
          case
            when p."supporterUntil" is null then r.timestamp
            when p."supporterUntil" > NOW() then (r.timestamp - 2592000000)::int8
            else r.timestamp
          end
      ) as "queueNo",
      r.userid,
      r.levelid,
      r."isChecked",
      r."needMod",
      r."reviewer",
      p."supporterUntil"
    from
      public.records r
      join public.players p on r.userid = p.uid
    where
      r."isChecked" = false
      and r."needMod" = false
      and r."reviewer" is null
  )
update records
set
  "queueNo" = RankedRecords."queueNo"
from
  RankedRecords
where
  records.userid = RankedRecords.userid
  and records.levelid = RankedRecords.levelid;

update public.records r
set
  "plPt" = sub."plPt"
from
  (
    select
      r.userid,
      r.levelid,
      case
        when r.progress <= 0
        or l."minProgress" is null
        or l."minProgress" <= 0 then 0
        else GREATEST(
          0.3 * COALESCE(l.rating, 0),
          COALESCE(l.rating, 0) * POWER(
            l."minProgress"::double precision / r.progress,
            0.5849625
          )
        )
      end as "plPt"
    from
      public.records r
      join public.levels l on l.id = r.levelid
    where
      r."isChecked" = true
      and l."isPlatformer" = true
  ) as sub
where
  r.userid = sub.userid
  and r.levelid = sub.levelid;

with
  ranked_plays as (
    select
      r.userid,
      r.levelid,
      r."plPt",
      ROW_NUMBER() over (
        partition by
          r.userid
        order by
          r."plPt" desc
      ) as rn
    from
      public.records r
      join public.levels l on l.id = r.levelid
    where
      r."isChecked" = true
      and l."isPlatformer" = true
  ),
  weighted as (
    select
      userid,
      "plPt",
      rn,
      case
        when rn = 1 then 0.5
        when rn = 2 then 0.3
        when rn = 3 then 0.15
        else GREATEST(0.01, 0.05 / POWER(rn - 3, 0.5))
      end as weight
    from
      ranked_plays
  ),
  sum_weighted as (
    select
      userid,
      SUM("plPt" * weight) as total_rating
    from
      weighted
    group by
      userid
  )
update public.players p
set
  "plRating" = case
    when sw.total_rating = 0 then null
    else sw.total_rating
  end
from
  sum_weighted sw
where
  p.uid = sw.userid;

with
  ranked_players as (
    select
      uid,
      RANK() over (
        order by
          "plRating" desc nulls last
      ) as rnk
    from
      public.players
  )
update public.players p
set
  "plrank" = rp.rnk
from
  ranked_players rp
where
  p.uid = rp.uid;
end$function$
;

CREATE OR REPLACE FUNCTION public.update_supporter_until()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
DECLARE
    user_record RECORD;
    order_record RECORD;
    current_supporter_until TIMESTAMP;
BEGIN
    -- Lp qua tng user c n hng
    FOR user_record IN 
        SELECT DISTINCT COALESCE("giftTo", "userID") as target_uid
        FROM orders 
        WHERE "productID" = 1 AND delivered = true
    LOOP
        current_supporter_until := NULL;
        
        -- X l tng n hng theo th t thi gian
        FOR order_record IN 
            SELECT created_at, quantity
            FROM orders 
            WHERE "productID" = 1 AND delivered = true
            AND COALESCE("giftTo", "userID") = user_record.target_uid
            ORDER BY created_at
        LOOP
            IF current_supporter_until IS NULL OR current_supporter_until < order_record.created_at THEN
                -- Nu cha c hoc  ht hn supporter
                current_supporter_until := order_record.created_at + INTERVAL '1 month' * order_record.quantity;
            ELSE
                -- Nu vn cn supporter, cng thm thi gian
                current_supporter_until := current_supporter_until + INTERVAL '1 month' * order_record.quantity;
            END IF;
        END LOOP;
        
        -- Cp nht vo database
        UPDATE players 
        SET "supporterUntil" = current_supporter_until
        WHERE uid = user_record.target_uid;
    END LOOP;
END;
$function$
;


